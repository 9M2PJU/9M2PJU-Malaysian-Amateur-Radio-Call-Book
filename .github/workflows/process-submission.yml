name: Process Callsign Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    if: contains(github.event.issue.labels.*.name, 'callsign-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse issue and create callsign entry
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Parse the issue body - GitHub form issues have a specific format
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              if (match && match[1]) {
                const value = match[1].trim();
                // Return empty string for "None" or "_No response_"
                if (value === '_No response_' || value === 'None' || value === 'none') {
                  return '';
                }
                return value;
              }
              return '';
            };
            
            const callsign = parseField('Callsign').toUpperCase();
            const name = parseField('Name').toUpperCase();
            const location = parseField('Location \\(State\\)');
            const email = parseField('Email \\(Optional\\)');
            const phone = parseField('Phone \\(Optional\\)');
            const address = parseField('Address \\(Optional\\)');
            const website = parseField('Website \\(Optional\\)');
            const facebook = parseField('Facebook \\(Optional\\)');
            const qrz = parseField('QRZ\\.com Profile \\(Optional\\)');
            
            // Validate callsign format
            const callsignRegex = /^9[MW][0-9][A-Z]{1,3}$/;
            if (!callsignRegex.test(callsign)) {
              core.setFailed(`Invalid callsign format: ${callsign}. Must be Malaysian format (e.g., 9M2ABC, 9W2XYZ)`);
              return;
            }
            
            // Create the new entry
            const today = new Date().toISOString().split('T')[0];
            const newEntry = {
              callsign,
              name,
              location,
              email,
              phone,
              address,
              website,
              facebook,
              qrz,
              addedDate: today
            };
            
            console.log('Parsed entry:', JSON.stringify(newEntry, null, 2));
            
            // Set outputs
            core.setOutput('callsign', callsign);
            core.setOutput('entry', JSON.stringify(newEntry));
            core.setOutput('valid', 'true');

      - name: Update callsigns.json
        if: steps.parse.outputs.valid == 'true'
        run: |
          ENTRY='${{ steps.parse.outputs.entry }}'
          CALLSIGN='${{ steps.parse.outputs.callsign }}'
          
          # Read current callsigns.json
          node -e "
            const fs = require('fs');
            const callsigns = JSON.parse(fs.readFileSync('public/callsigns.json', 'utf8'));
            const newEntry = JSON.parse(process.env.ENTRY);
            
            // Check if callsign already exists
            const existingIndex = callsigns.findIndex(c => c.callsign === newEntry.callsign);
            
            if (existingIndex >= 0) {
              // Update existing entry
              callsigns[existingIndex] = newEntry;
              console.log('Updated existing entry for ' + newEntry.callsign);
            } else {
              // Add new entry at the beginning
              callsigns.unshift(newEntry);
              console.log('Added new entry for ' + newEntry.callsign);
            }
            
            fs.writeFileSync('public/callsigns.json', JSON.stringify(callsigns, null, 4) + '\n');
            console.log('Successfully updated callsigns.json');
          "
        env:
          ENTRY: ${{ steps.parse.outputs.entry }}

      - name: Create Pull Request
        if: steps.parse.outputs.valid == 'true'
        uses: peter-evans/create-pull-request@v6
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add/Update callsign ${{ steps.parse.outputs.callsign }}"
          title: "üìª Add/Update callsign: ${{ steps.parse.outputs.callsign }}"
          body: |
            ## New Callsign Registration
            
            This PR was automatically created from issue #${{ github.event.issue.number }}.
            
            **Callsign:** ${{ steps.parse.outputs.callsign }}
            
            ### Review Checklist
            - [ ] Verify the callsign format is correct
            - [ ] Check for duplicate entries
            - [ ] Confirm the information looks legitimate
            
            ---
            
            **To approve:** Simply merge this PR.
            **To reject:** Close this PR without merging.
            
            Closes #${{ github.event.issue.number }}
          branch: callsign/${{ steps.parse.outputs.callsign }}
          delete-branch: true
          labels: |
            callsign-submission
            automated-pr

      - name: Comment on issue
        if: steps.parse.outputs.valid == 'true' && steps.cpr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚úÖ Thank you for your submission!\n\nA Pull Request has been created: #${{ steps.cpr.outputs.pull-request-number }}\n\nThe maintainer will review and approve your registration shortly. Once approved, your callsign will appear in the directory.\n\n73 de 9M2PJU üìª`
            });

      - name: Handle invalid submission
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚ùå There was an issue processing your submission. Please ensure:\n\n1. Your callsign is in the correct Malaysian format (e.g., 9M2ABC, 9W2XYZ)\n2. All required fields are filled in correctly\n\nPlease close this issue and submit a new one with the correct information.\n\n73 de 9M2PJU üìª`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['invalid']
            });
